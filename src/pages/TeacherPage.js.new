import React, { useState, useEffect } from 'react';
import { useCollection } from 'react-firebase-hooks/firestore';
import { collection, doc, updateDoc, arrayUnion, setDoc, getDocs, query, orderBy, deleteDoc, getDoc, addDoc, limit } from 'firebase/firestore';
import { db } from '../firebase';
import StudentCard from '../components/StudentCard';
import NotificationsActiveIcon from '@mui/icons-material/NotificationsActive';
import Checkbox from '@mui/material/Checkbox';
import EmojiEventsIcon from '@mui/icons-material/EmojiEvents';
import { useNavigate } from 'react-router-dom';
import StorefrontIcon from '@mui/icons-material/Storefront';
import SportsEsportsIcon from '@mui/icons-material/SportsEsports';

const LEVELS = [
  'ì•Œì‚¬íƒ•',
  'ìƒˆì½¤í•œ ì‚¬íƒ•',
  'ë§‰ëŒ€ì‚¬íƒ•',
  'ë¡¤ë¦¬íŒ',
  'ìˆ˜ì œ ì‚¬íƒ•',
  'ì‚¬íƒ• ë§ˆìŠ¤í„°',
];

const STUDENT_ORDER = [
  'ê¹€ê·œë¯¼','ê¹€ë²”ì¤€','ê¹€ì„±ì¤€','ê¹€ìˆ˜ê²¸','ê¹€ì£¼ì›','ë¬¸ê¸°í›ˆ','ë°•ë™í•˜','ë°±ì£¼ì›','ë°±ì§€ì›','ì†ì •í™˜','ì´ë„ìœ¤','ì´ì˜ˆì¤€','ì„ì¬í¬','ì¡°ì€ë¹ˆ','ì¡°ì°¬í¬','ìµœì„œìœ¤','ìµœì„œí˜„','í•œì„œìš°','í™©ë¦¬ì•„','í•˜ì§€ìˆ˜','í…ŒìŠ¤íŠ¸'
];

const REACTION_COLORS = [
  { name: 'ë¹¨ê°•', code: '#e53935' },
  { name: 'ì£¼í™©', code: '#fb8c00' },
  { name: 'ë…¸ë‘', code: '#fbc02d' },
  { name: 'ì´ˆë¡', code: '#43a047' },
  { name: 'íŒŒë‘', code: '#1e88e5' },
  { name: 'ë‚¨ìƒ‰', code: '#3949ab' },
  { name: 'ë³´ë¼', code: '#8e24aa' },
];

// ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê³µí†µ ê°ì²´
const buttonStyle = {
  fontSize: 13,
  minWidth: 72,
  padding: '7px 14px',
  whiteSpace: 'nowrap',
  borderRadius: 12,
  fontWeight: 'bold',
  boxShadow: '0 2px 8px #b2ebf240',
  transition: 'all 0.2s',
  cursor: 'pointer',
};

const TeacherPage = () => {
  // ëª¨ë“  useState, useEffect ë“± Hook ì„ ì–¸
  const [studentsSnapshot, loading, error] = useCollection(collection(db, 'students'));
  const [selectedIds, setSelectedIds] = useState([]);
  const [showMessageModal, setShowMessageModal] = useState(false);
  const [showQuestModal, setShowQuestModal] = useState(false);
  const [messageText, setMessageText] = useState('');
  const [questText, setQuestText] = useState('');
  const [expEffectIds, setExpEffectIds] = useState([]);
  const [levelUpEffectIds, setLevelUpEffectIds] = useState([]);
  const [showTeacherAlarm, setShowTeacherAlarm] = useState(false);
  const [pendingRequests, setPendingRequests] = useState([]);
  const [rejectReason, setRejectReason] = useState('');
  const [selectedRequest, setSelectedRequest] = useState(null);
  const [alarmTab, setAlarmTab] = useState('message');
  const [questExp, setQuestExp] = useState(10);
  const [questActionStudent, setQuestActionStudent] = useState(null);
  const [questActionQuest, setQuestActionQuest] = useState(null);
  const [questResultEffect, setQuestResultEffect] = useState('');
  const [showJarModal, setShowJarModal] = useState(false);
  const [showBoardModal, setShowBoardModal] = useState(false);
  const [showCreateBoardModal, setShowCreateBoardModal] = useState(false);
  const [newBoardTitle, setNewBoardTitle] = useState('');
  const [showBoardChoiceModal, setShowBoardChoiceModal] = useState(false);
  const [showBoardCodeModal, setShowBoardCodeModal] = useState(false);
  const [boardCodeInput, setBoardCodeInput] = useState('');
  const [showBoardListModal, setShowBoardListModal] = useState(false);
  const [boardList, setBoardList] = useState([]);
  const [boardListLoading, setBoardListLoading] = useState(false);
  const [showBankModal, setShowBankModal] = useState(false);
  const [bankTab, setBankTab] = useState('balance');
  const [bankBalances, setBankBalances] = useState({});
  const [bankSelectedIds, setBankSelectedIds] = useState([]);
  const [showBankAmountModal, setShowBankAmountModal] = useState(false);
  const [bankAmountType, setBankAmountType] = useState('deposit');
  const [bankAmountValue, setBankAmountValue] = useState(0);
  const [bankSaving, setBankSaving] = useState(false);
  const [bankNames, setBankNames] = useState({});
  const [showAddStudentModal, setShowAddStudentModal] = useState(false);
  const [newStudentName, setNewStudentName] = useState('');
  const [newStudentBalance, setNewStudentBalance] = useState(0);
  const [items, setItems] = useState([]);
  const [itemNames, setItemNames] = useState({});
  const [itemPrices, setItemPrices] = useState({});
  const [showAddItemModal, setShowAddItemModal] = useState(false);
  const [newItemName, setNewItemName] = useState('');
  const [newItemPrice, setNewItemPrice] = useState(0);
  const [itemSaving, setItemSaving] = useState(false);
  const navigate = useNavigate();
  const [syncing, setSyncing] = useState(false);
  const [showAmountModal, setShowAmountModal] = useState(false);
  const [amountType, setAmountType] = useState('deposit');
  const [amountValue, setAmountValue] = useState(0);
  const [showGameModal, setShowGameModal] = useState(false);
  const [gameStep, setGameStep] = useState('select'); // select | reaction
  const [targetColor, setTargetColor] = useState(null);
  const [currentColor, setCurrentColor] = useState(null);
  const [gameStarted, setGameStarted] = useState(false);
  const [startTime, setStartTime] = useState(0);
  const [reactionTime, setReactionTime] = useState(null);
  const [gameError, setGameError] = useState('');
  const [topRecords, setTopRecords] = useState([]);
  const [isClickable, setIsClickable] = useState(false);
  const [studentName, setStudentName] = useState('');

  // í•™ìƒ ì´ˆê¸° ë°ì´í„° (ì œì‹œëœ ê°’)
  const initialStudents = [
    { name: 'ê¹€ê·œë¯¼', balance: 177 },
    { name: 'ê¹€ë²”ì¤€', balance: 143 },
    { name: 'ê¹€ì„±ì¤€', balance: 44 },
    { name: 'ê¹€ìˆ˜ê²¸', balance: 0 },
    { name: 'ê¹€ì£¼ì›', balance: 51 },
    { name: 'ë¬¸ê¸°í›ˆ', balance: 150 },
    { name: 'ë°•ë™í•˜', balance: 0 },
    { name: 'ë°±ì£¼ì›', balance: 58 },
    { name: 'ë°±ì§€ì›', balance: 4 },
    { name: 'ì†ì •í™˜', balance: 34 },
    { name: 'ì´ë„ìœ¤', balance: 61 },
    { name: 'ì´ì˜ˆì¤€', balance: 143 },
    { name: 'ì„ì¬í¬', balance: 100 },
    { name: 'ì¡°ì€ë¹ˆ', balance: 28 },
    { name: 'ì¡°ì°¬í¬', balance: 45 },
    { name: 'ìµœì„œìœ¤', balance: 28 },
    { name: 'ìµœì„œí˜„', balance: 1 },
    { name: 'í•œì„œìš°', balance: 0 },
    { name: 'í™©ë¦¬ì•„', balance: 120 },
    { name: 'í•˜ì§€ìˆ˜', balance: 102 },
    { name: 'í…ŒìŠ¤íŠ¸', balance: 100 }
  ];

  // í’ˆëª© ì´ˆê¸° ë°ì´í„° (ì œì‹œëœ ê°’)
  const initialItems = [
    { name: 'ë§ˆì´ì®¸', price: 3 },
    { name: 'í•˜ë¦¬ë³´', price: 8 },
    { name: 'ìƒˆì½¤ë‹¬ì½¤', price: 4 },
    { name: 'ì¸„íŒŒì¶¥ìŠ¤', price: 8 },
    { name: 'ì‚¬ì›Œë°”ì´ì¸ ', price: 12 },
    { name: 'ìŒì•…ë“£ê¸°', price: 4 },
    { name: 'ìŒì•…2ê³¡ë“£ê¸°', price: 7 },
    { name: 'ê³ ë˜ë°¥', price: 18 },
    { name: 'ìë¦¬êµ¬ì…', price: 135 }
  ];

  // Firestoreì— ë™ê¸°í™”(ìµœì´ˆ 1íšŒë§Œ, studentsSnapshotì´ ë¹„ì–´ìˆì„ ë•Œë§Œ)
  useEffect(() => {
    const checkAndInit = async () => {
      // 'init_done' ë§ˆì»¤ ë¬¸ì„œ í™•ì¸
      const markerRef = doc(db, 'meta', 'init_done');
      const markerSnap = await getDoc(markerRef);
      if (!markerSnap.exists()) {
        // 1. students ì»¬ë ‰ì…˜ ì „ì²´ ì‚­ì œ
        const q = query(collection(db, 'students'));
        const snap = await getDocs(q);
        for (const docSnap of snap.docs) {
          await deleteDoc(doc(db, 'students', docSnap.id));
        }
        // 2. initialStudents ë™ê¸°í™”
        for (const s of initialStudents) {
          await setDoc(doc(db, 'students', s.name), { name: s.name, balance: s.balance }, { merge: true });
        }
        // 3. ë§ˆì»¤ ë¬¸ì„œ ìƒì„± (ì´ˆê¸°í™” ì™„ë£Œ í‘œì‹œ)
        await setDoc(markerRef, { done: true, ts: Date.now() });
      }
    };
    checkAndInit();
  }, []); // ìµœì´ˆ 1íšŒë§Œ ì‹¤í–‰

  // í’ˆëª© Firestore ë™ê¸°í™” (ìµœì´ˆ 1íšŒë§Œ, items ì»¬ë ‰ì…˜ì´ ë¹„ì–´ìˆì„ ë•Œë§Œ)
  useEffect(() => {
    const syncInitialItems = async () => {
      const q = query(collection(db, 'items'));
      const snap = await getDocs(q);
      if (snap.empty) {
        // ê¸°ì¡´ ë¬¸ì„œê°€ ë‚¨ì•„ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ëª¨ë‘ ì‚­ì œ
        for (const docSnap of snap.docs) {
          await deleteDoc(doc(db, 'items', docSnap.id));
        }
        // ì´ˆê¸° í’ˆëª© ë°ì´í„° ì…ë ¥
        for (const item of initialItems) {
          await setDoc(doc(db, 'items', item.name), { name: item.name, price: item.price }, { merge: true });
        }
      }
    };
    syncInitialItems();
  }, []);

  // --- í•™ê¸‰ ìº”ë”” ìœ ë¦¬ë³‘ ì§‘ê³„ ---
  // ì‚¬íƒ• ì´ë¯¸ì§€ ê²½ë¡œ
  const candyImages = [
    '/lv1.png', '/lv2.png', '/lv3.png', '/lv4.png', '/lv5.png', '/lv6.png'
  ];
  // ì‚¬íƒ•ë³„ ëˆ„ì  ê°œìˆ˜ ì§‘ê³„ (ë ˆë²¨ì—… ì‹œì ë§ˆë‹¤ ì´ì „ ë ˆë²¨ ì‚¬íƒ• +1)
  const candyCounts = [0,0,0,0,0,0];
  if (studentsSnapshot) {
    studentsSnapshot.docs.forEach(doc => {
      const student = doc.data();
      let prevLevel = 0;
      let curLevel = student.level || 0;
      // expEventsì—ì„œ type: 'levelup'ì´ ìˆìœ¼ë©´ ê·¸ê±¸, ì—†ìœ¼ë©´ ë ˆë²¨ ë³€í™” ì¶”ì •
      // ë ˆë²¨ì—… ì´ë ¥ ì¶”ì •: expEventsì—ì„œ ê²½í—˜ì¹˜ë¡œ ë ˆë²¨ì—… ì‹œì  ê³„ì‚°
      let exp = 0;
      let level = 0;
      if (Array.isArray(student.expEvents)) {
        student.expEvents.forEach(evt => {
          if (evt.type === 'exp' || evt.type === 'friendPraise' || evt.type === 'selfPraise' || evt.type === 'quest') {
            exp += evt.amount || 0;
            let required = 150 + level * 10;
            while (exp >= required) {
              exp -= required;
              // ë ˆë²¨ì—…: ì´ì „ ë ˆë²¨ ì‚¬íƒ• +1
              if (level < 6) candyCounts[level]++;
              level++;
              required = 150 + level * 10;
            }
          }
        });
      }
    });
  }

  useEffect(() => {
    if (!studentsSnapshot) return;
    let requests = [];
    studentsSnapshot.docs.forEach(docSnap => {
      const student = docSnap.data();
      // ë©”ì‹œì§€
      (student.messages || []).filter(m => m.from === 'student' && !m.checked).forEach(m => {
        requests.push({ type: 'message', studentId: docSnap.id, studentName: student.name, ...m });
      });
      // ì¹œêµ¬/ìê¸° ì¹­ì°¬
      (student.praise || []).filter(p => !p.checked).forEach(p => {
        requests.push({ type: p.self ? 'selfPraise' : 'friendPraise', studentId: docSnap.id, studentName: student.name, ...p });
      });
    });
    setPendingRequests(requests.sort((a,b)=>b.ts-a.ts));
  }, [studentsSnapshot]);

  // í•™ìƒ ì”ì•¡ ì´ˆê¸°í™” (studentsSnapshot ë³€ê²½ ì‹œ)
  useEffect(() => {
    if (!studentsSnapshot) return;
    const balances = {};
    studentsSnapshot.docs.forEach(doc => {
      const s = doc.data();
      balances[doc.id] = typeof s.balance === 'number' ? s.balance : 0;
    });
    setBankBalances(balances);
  }, [studentsSnapshot]);

  // í’ˆëª© ë¶ˆëŸ¬ì˜¤ê¸°
  useEffect(() => {
    const fetchItems = async () => {
      const q = query(collection(db, 'items'));
      const snap = await getDocs(q);
      setItems(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      const names = {}, prices = {};
      snap.docs.forEach(d => {
        names[d.id] = d.data().name;
        prices[d.id] = d.data().price;
      });
      setItemNames(names);
      setItemPrices(prices);
    };
    fetchItems();
  }, []);

  // ì¡°ê±´ë¶€ ë Œë”ë§
  if (loading || syncing) return <div style={{textAlign:'center',marginTop:40}}>ë¡œë”© ì¤‘...</div>;
  if (error) return <div style={{color:'red',textAlign:'center',marginTop:40}}>ì—ëŸ¬ ë°œìƒ: {error.message}</div>;
  if (!studentsSnapshot || studentsSnapshot.empty) return <div style={{textAlign:'center',marginTop:40}}>í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>;

  // ì „ì²´ ì„ íƒ/í•´ì œ
  const handleSelectAll = () => {
    if (!studentsSnapshot) return;
    if (selectedIds.length === studentsSnapshot.docs.length) {
      setSelectedIds([]);
    } else {
      setSelectedIds(studentsSnapshot.docs.map(doc => doc.id));
    }
  };

  // ê°œë³„ ì„ íƒ
  const handleSelect = (id) => {
    setSelectedIds((prev) =>
      prev.includes(id) ? prev.filter((sid) => sid !== id) : [...prev, id]
    );
  };

  // ëœë¤ 2ëª… ì„ íƒ
  const handleSelectRandomTwo = () => {
    if (!studentsSnapshot) return;
    const docs = studentsSnapshot.docs;
    if (docs.length <= 2) {
      setSelectedIds(docs.map(doc => doc.id));
    } else {
      const shuffled = docs.map(doc => doc.id).sort(() => Math.random() - 0.5);
      setSelectedIds([shuffled[0], shuffled[1]]);
    }
  };

  // ê²½í—˜ì¹˜/ë ˆë²¨ì—… ì´í™íŠ¸
  const triggerExpEffect = (id) => {
    setExpEffectIds((prev) => [...prev, id]);
    setTimeout(() => setExpEffectIds((prev) => prev.filter(eid => eid !== id)), 1200);
  };
  const triggerLevelUpEffect = (id) => {
    setLevelUpEffectIds((prev) => [...prev, id]);
    setTimeout(() => setLevelUpEffectIds((prev) => prev.filter(eid => eid !== id)), 1500);
  };

  // ë ˆë²¨ì—… í•„ìš” ê²½í—˜ì¹˜ ê³„ì‚° í•¨ìˆ˜
  const getRequiredExp = (level) => 150 + level * 10;

  // ë°œí‘œ ê²½í—˜ì¹˜ ë¶€ì—¬
  const handleGiveExp = async () => {
    if (!studentsSnapshot) return;
    const todayStr = new Date().toISOString().slice(0, 10);
    for (const docSnap of studentsSnapshot.docs) {
      if (selectedIds.includes(docSnap.id)) {
        const student = docSnap.data();
        let newExp = (typeof student.exp === 'number' && !isNaN(student.exp) ? student.exp : 0) + 10;
        let newLevel = typeof student.level === 'number' && !isNaN(student.level) ? student.level : 0;
        let levelUp = false;
        let requiredExp = getRequiredExp(newLevel);
        while (newExp >= requiredExp) {
          newExp -= requiredExp;
          newLevel += 1;
          levelUp = true;
          requiredExp = getRequiredExp(newLevel);
        }
        // ë°œí‘œ ê¸°ë¡ ì¶”ê°€
        const presentations = Array.isArray(student.presentations) ? [...student.presentations] : [];
        presentations.push({ date: todayStr, ts: Date.now() });
        await updateDoc(doc(db, 'students', docSnap.id), {
          exp: newExp,
          level: newLevel,
          expEvents: arrayUnion({ type: 'exp', amount: 10, ts: Date.now() })
        });
        triggerExpEffect(docSnap.id);
        if (levelUp) triggerLevelUpEffect(docSnap.id);
      }
    }
  };

  // ë©”ì‹œì§€ ëª¨ë‹¬
  const handleSendMessage = async () => {
    if (!studentsSnapshot) return;
    for (const docSnap of studentsSnapshot.docs) {
      if (selectedIds.includes(docSnap.id)) {
        const student = docSnap.data();
        const newMessages = [...(student.messages || []), { from: 'teacher', text: messageText, ts: Date.now() }];
        await updateDoc(doc(db, 'students', docSnap.id), {
          messages: newMessages,
        });
      }
    }
    setShowMessageModal(false);
    setMessageText('');
  };

  // í€˜ìŠ¤íŠ¸ ëª¨ë‹¬
  const handleSendQuest = async () => {
    if (!studentsSnapshot) return;
    for (const docSnap of studentsSnapshot.docs) {
      if (selectedIds.includes(docSnap.id)) {
        const student = docSnap.data();
        const newQuests = [...(student.quests || []), { from: 'teacher', text: questText, ts: Date.now(), exp: questExp, status: 'ongoing' }];
        await updateDoc(doc(db, 'students', docSnap.id), {
          quests: newQuests
        });
      }
    }
    setShowQuestModal(false);
    setQuestText('');
    setQuestExp(10);
  };

  // ìŠ¹ì¸ ì²˜ë¦¬
  const handleApprove = async (req) => {
    if (req.type === 'friendPraise') {
      // ì¹œêµ¬ë“¤ì—ê²Œ ê²½í—˜ì¹˜ ì§€ê¸‰
      for (const friendId of req.friends || []) {
        const friendRef = doc(db, 'students', friendId);
        const friendSnap = studentsSnapshot.docs.find(d => d.id === friendId);
        if (!friendSnap) continue;
        let friend = friendSnap.data();
        let newExp = friend.exp + req.exp;
        let newLevel = friend.level;
        let levelUp = false;
        let requiredExp = getRequiredExp(friend.level);
        while (newExp >= requiredExp) {
          newExp -= requiredExp;
          newLevel += 1;
          levelUp = true;
          requiredExp = getRequiredExp(newLevel);
        }
        await updateDoc(friendRef, {
          exp: newExp,
          level: newLevel,
          expEvents: arrayUnion({ type: 'friendPraise', amount: req.exp, ts: Date.now(), text: req.text, from: req.studentName, result: 'approved' })
        });
      }
      // ì¹­ì°¬ ìš”ì²­ì ì¹­ì°¬ checked ì²˜ë¦¬
      const studentRef = doc(db, 'students', req.studentId);
      const studentSnap = studentsSnapshot.docs.find(d => d.id === req.studentId);
      let student = studentSnap.data();
      let praiseArr = (student.praise || []).map(p => p.ts === req.ts ? { ...p, checked: true, result: 'approved' } : p);
      await updateDoc(studentRef, { praise: praiseArr });
    } else if (req.type === 'selfPraise') {
      // ìê¸° ì¹­ì°¬: ë³¸ì¸ì—ê²Œ ê²½í—˜ì¹˜ ì§€ê¸‰
      const studentRef = doc(db, 'students', req.studentId);
      const studentSnap = studentsSnapshot.docs.find(d => d.id === req.studentId);
      let student = studentSnap.data();
      let newExp = student.exp + req.exp;
      let newLevel = student.level;
      let levelUp = false;
      let requiredExp = getRequiredExp(student.level);
      while (newExp >= requiredExp) {
        newExp -= requiredExp;
        newLevel += 1;
        levelUp = true;
        requiredExp = getRequiredExp(newLevel);
      }
      let praiseArr = (student.praise || []).map(p => p.ts === req.ts ? { ...p, checked: true, result: 'approved' } : p);
      await updateDoc(studentRef, {
        exp: newExp,
        level: newLevel,
        praise: praiseArr,
        expEvents: arrayUnion({ type: 'selfPraise', amount: req.exp, ts: Date.now(), text: req.text, result: 'approved' })
      });
    } else if (req.type === 'message') {
      // ë©”ì‹œì§€ checked ì²˜ë¦¬
      const studentRef = doc(db, 'students', req.studentId);
      const studentSnap = studentsSnapshot.docs.find(d => d.id === req.studentId);
      let student = studentSnap.data();
      let msgArr = (student.messages || []).map(m => m.ts === req.ts ? { ...m, checked: true } : m);
      await updateDoc(studentRef, { messages: msgArr });
    }
    setSelectedRequest(null);
  };
  // ê±°ì ˆ ì²˜ë¦¬
  const handleReject = async (req) => {
    if (!rejectReason) return;
    const studentRef = doc(db, 'students', req.studentId);
    const studentSnap = studentsSnapshot.docs.find(d => d.id === req.studentId);
    let student = studentSnap.data();
    if (req.type === 'friendPraise' || req.type === 'selfPraise') {
      let praiseArr = (student.praise || []).map(p => p.ts === req.ts ? { ...p, checked: true, result: 'rejected', reason: rejectReason } : p);
      await updateDoc(studentRef, {
        praise: praiseArr,
        expEvents: arrayUnion({ type: req.type, amount: 0, ts: Date.now(), text: req.text, result: 'rejected', reason: rejectReason })
      });
    }
    setRejectReason('');
    setSelectedRequest(null);
  };

  // í€˜ìŠ¤íŠ¸ ì„±ê³µ/ì‹¤íŒ¨ ì²˜ë¦¬
  const handleQuestResult = async (studentId, quest, result) => {
    const studentDoc = studentsSnapshot.docs.find(d => d.id === studentId);
    if (!studentDoc) return;
    const student = studentDoc.data();
    let newQuests = (student.quests || []).map(q =>
      q.ts === quest.ts ? { ...q, status: result } : q
    );
    let updates = { quests: newQuests };
    if (result === 'success') {
      // ê²½í—˜ì¹˜ ì§€ê¸‰ ë° ë ˆë²¨ì—… ì²˜ë¦¬
      let newExp = (typeof student.exp === 'number' && !isNaN(student.exp) ? student.exp : 0) + quest.exp;
      let newLevel = typeof student.level === 'number' && !isNaN(student.level) ? student.level : 0;
      let levelUp = false;
      let requiredExp = getRequiredExp(newLevel);
      while (newExp >= requiredExp) {
        newExp -= requiredExp;
        newLevel += 1;
        levelUp = true;
        requiredExp = getRequiredExp(newLevel);
      }
      updates.exp = newExp;
      updates.level = newLevel;
      updates.expEvents = arrayUnion({ type: 'quest', amount: quest.exp, ts: Date.now(), text: quest.text });
      triggerExpEffect(studentDoc.id);
      if (levelUp) triggerLevelUpEffect(studentDoc.id);
      setQuestResultEffect('í€˜ìŠ¤íŠ¸ ì„±ê³µ! ê²½í—˜ì¹˜ ì§€ê¸‰ ğŸ‰');
      setTimeout(() => setQuestResultEffect(''), 1500);
    } else {
      setQuestResultEffect('í€˜ìŠ¤íŠ¸ ì‹¤íŒ¨ ğŸ˜¢');
      setTimeout(() => setQuestResultEffect(''), 1500);
    }
    await updateDoc(doc(db, 'students', studentDoc.id), updates);
    setQuestActionStudent(null);
    setQuestActionQuest(null);
  };

  // ê°œë³„ ì•ŒëŒ ì½ìŒ ì²˜ë¦¬
  const handleMarkAsRead = async (req) => {
    const studentRef = doc(db, 'students', req.studentId);
    const studentSnap = studentsSnapshot.docs.find(d => d.id === req.studentId);
    let student = studentSnap.data();
    if (req.type === 'message') {
      let msgArr = (student.messages || []).map(m => m.ts === req.ts ? { ...m, checked: true } : m);
      await updateDoc(studentRef, { messages: msgArr });
    } else if (req.type === 'friendPraise' || req.type === 'selfPraise') {
      let praiseArr = (student.praise || []).map(p => p.ts === req.ts ? { ...p, checked: true } : p);
      await updateDoc(studentRef, { praise: praiseArr });
    }
  };
  // ëª¨ë‘ ì½ìŒ ì²˜ë¦¬
  const handleMarkAllAsRead = async (type) => {
    const filtered = pendingRequests.filter(r => (type === 'message' ? r.type === 'message' : (r.type === 'friendPraise' || r.type === 'selfPraise')));
    for (const req of filtered) {
      await handleMarkAsRead(req);
    }
  };

  function generateBoardCode() {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
  }
  const handleCreateBoard = async () => {
    if (!newBoardTitle.trim()) return;
    const code = generateBoardCode();
    await setDoc(doc(db, 'boards', code), {
      code,
      createdAt: new Date(),
      columns: [],
      title: newBoardTitle.trim(),
    });
    setShowCreateBoardModal(false);
    setShowBoardModal(false);
    setNewBoardTitle('');
    navigate(`/board/${code}`);
  };

  // ê²Œì‹œíŒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  const fetchBoardList = async () => {
    setBoardListLoading(true);
    const q = query(collection(db, 'boards'), orderBy('createdAt', 'desc'));
    const snap = await getDocs(q);
    setBoardList(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    setBoardListLoading(false);
  };

  // studentsSnapshotì´ ë¹„ì–´ìˆìœ¼ë©´ initialStudentsë¥¼ í™”ë©´ì— ì§ì ‘ ë Œë”ë§
  const studentRows = (studentsSnapshot && !studentsSnapshot.empty)
    ? studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
    : initialStudents.map(s => ({ id: s.name, ...s }));

  const order = initialStudents.map(s => s.name);

  const handleAmount = async () => {
    if (!studentsSnapshot) return;
    for (const id of bankSelectedIds) {
      const docSnap = studentsSnapshot.docs.find(d => d.id === id);
      if (!docSnap) continue;
      const student = docSnap.data();
      let newBalance = student.balance || 0;
      if (amountType === 'deposit') newBalance += amountValue;
      else if (amountType === 'withdraw') newBalance -= amountValue;
      await updateDoc(doc(db, 'students', id), { balance: newBalance });
    }
    setShowAmountModal(false);
    setAmountValue(0);
  };

  // ê²Œì„ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  const fetchTopRecords = async () => {
    const q = query(collection(db, 'reactionGameRecords'), orderBy('ms', 'asc'), limit(5));
    const snap = await getDocs(q);
    setTopRecords(snap.docs.map(d => d.data()));
  };

  return (
    <div style={{ minHeight: '100vh', width: '100vw', padding: '32px',
      background: 'linear-gradient(135deg, rgba(224,247,250,0.6) 0%, rgba(227,242,253,0.6) 100%), url(/TR_bg.png) center/cover no-repeat',
      backgroundBlendMode: 'normal',
      boxSizing: 'border-box' }}>
      {/* ë°°ë„ˆ ì´ë¯¸ì§€ */}
      <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', marginBottom: 32, marginTop: 8 }}>
        <img src="/candyshop_banner.png" alt="JAMMANBO CANDY SHOP ë°°ë„ˆ" style={{ maxWidth: 480, width: '90vw', height: 'auto', borderRadius: 18, boxShadow: '0 4px 24px #b2ebf240', display: 'block' }} />
      </div>
      <div style={{ display: 'flex', justifyContent: 'center', gap: 16, marginBottom: 16 }}>
        <button
          onClick={handleSelectAll}
          style={{
            background: '#fffefb', border: '2px solid #a7d7c5', color: '#1976d2', fontWeight: 'bold', borderRadius: 12, boxShadow: '0 2px 8px #a7d7c540', padding: '8px 18px', fontSize: 14, minWidth: 70, transition: 'all 0.2s', cursor: 'pointer'
          }}
        >ì „ì²´ ì„ íƒ/í•´ì œ</button>
        <button
          onClick={handleSelectRandomTwo}
          style={{
            background: '#fffefb', border: '2px solid #a7d7c5', color: '#43a047', fontWeight: 'bold', borderRadius: 12, boxShadow: '0 2px 8px #a7d7c540', padding: '8px 18px', fontSize: 14, minWidth: 70, transition: 'all 0.2s', cursor: 'pointer'
          }}
        >ëœë¤ 2ëª… ì„ íƒ</button>
        <button
          onClick={handleGiveExp}
          disabled={selectedIds.length === 0}
          style={{
            background: selectedIds.length ? '#ffe4ec' : '#f7faf7',
            border: selectedIds.length ? '2px solid #ffb6b9' : '2px solid #a7d7c5',
            color: '#d72660', fontWeight: 'bold', borderRadius: 12, boxShadow: '0 2px 8px #f8bbd0a0', padding: '8px 18px', fontSize: 14, minWidth: 70, transition: 'all 0.2s', cursor: selectedIds.length ? 'pointer' : 'not-allowed', opacity: selectedIds.length ? 1 : 0.5
          }}
        >ë°œí‘œ ê²½í—˜ì¹˜</button>
        <button
          onClick={() => setShowMessageModal(true)}
          disabled={selectedIds.length === 0}
          style={{
            background: selectedIds.length ? '#ffe4ec' : '#f7faf7',
            border: selectedIds.length ? '2px solid #ffb6b9' : '2px solid #a7d7c5',
            color: '#d72660', fontWeight: 'bold', borderRadius: 12, boxShadow: '0 2px 8px #f8bbd0a0', padding: '8px 18px', fontSize: 14, minWidth: 70, transition: 'all 0.2s', cursor: selectedIds.length ? 'pointer' : 'not-allowed', opacity: selectedIds.length ? 1 : 0.5
          }}
        >ë©”ì„¸ì§€ ë³´ë‚´ê¸°</button>
        <button
          onClick={() => setShowQuestModal(true)}
          disabled={selectedIds.length === 0}
          style={{
            background: selectedIds.length ? '#ffe4ec' : '#f7faf7',
            border: selectedIds.length ? '2px solid #ffb6b9' : '2px solid #a7d7c5',
            color: '#d72660', fontWeight: 'bold', borderRadius: 12, boxShadow: '0 2px 8px #f8bbd0a0', padding: '8px 18px', fontSize: 14, minWidth: 70, transition: 'all 0.2s', cursor: selectedIds.length ? 'pointer' : 'not-allowed', opacity: selectedIds.length ? 1 : 0.5
          }}
        >í€˜ìŠ¤íŠ¸ ì£¼ê¸°</button>
        <button
          onClick={() => setShowBoardChoiceModal(true)}
          style={{
            background: '#e0f7fa', border: '2px solid #1976d2', color: '#1976d2', fontWeight: 'bold', borderRadius: 12, boxShadow: '0 2px 8px #b2ebf240', padding: '8px 18px', fontSize: 14, minWidth: 70, transition: 'all 0.2s', cursor: 'pointer', marginLeft: 0
          }}
        >ê²Œì‹œíŒ ê°œì„¤</button>
      </div>
      <div style={{ marginTop: '24px', display: 'flex', flexWrap: 'wrap', gap: '24px', justifyContent: 'center' }}>
        {studentsSnapshot && studentsSnapshot.docs
          .slice()
          .sort((a, b) => order.indexOf(a.data().name) - order.indexOf(b.data().name))
          .map(doc => {
            const student = doc.data();
            // level, exp ì•ˆì „ ì²˜ë¦¬
            const level = typeof student.level === 'number' && !isNaN(student.level) ? student.level : 0;
            const exp = typeof student.exp === 'number' && !isNaN(student.exp) ? student.exp : 0;
            const levelName = LEVELS[level] || LEVELS[0];
            return (
              <StudentCard
                key={doc.id}
                student={{ ...student, level, exp, levelName }}
                selected={selectedIds.includes(doc.id)}
                onSelect={() => handleSelect(doc.id)}
                onOptionClick={(option) => {
                  if (option === 'exp') handleGiveExp();
                  if (option === 'message') setShowMessageModal(true);
                  if (option === 'quest') setShowQuestModal(true);
                }}
                expEffect={expEffectIds.includes(doc.id)}
                levelUpEffect={levelUpEffectIds.includes(doc.id)}
                onQuestClick={(quest) => { setQuestActionStudent({ id: doc.id, name: student.name }); setQuestActionQuest(quest); }}
                onQuestApprove={(quest) => handleQuestResult(doc.id, quest, 'success')}
                onQuestFail={(quest) => handleQuestResult(doc.id, quest, 'fail')}
              />
            );
          })}
      </div>
      {/* ë©”ì‹œì§€ ëª¨ë‹¬ */}
      {showMessageModal && (
        <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.3)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
          <div style={{ background: '#fff', padding: '32px 28px 24px 28px', borderRadius: 28, minWidth: 320, boxShadow: '0 4px 32px #b2ebf240', maxWidth: '90vw' }}>
            <div style={{ fontWeight: 700, fontSize: '1.25rem', marginBottom: 18, color: '#1976d2', letterSpacing: '-0.5px' }}>ë©”ì„¸ì§€ ë³´ë‚´ê¸°</div>
            <textarea value={messageText} onChange={e => setMessageText(e.target.value)} style={{ width: '100%', minHeight: 80, borderRadius: 14, border: '2px solid #e0f7fa', padding: 12, fontSize: 16, outline: 'none', resize: 'vertical', marginBottom: 18, boxSizing: 'border-box', background: '#f7faf7', color: '#222', transition: 'border 0.2s' }} />
            <div style={{ marginTop: 0, textAlign: 'right', display: 'flex', gap: 10, justifyContent: 'flex-end' }}>
              <button onClick={() => setShowMessageModal(false)} style={{ fontWeight: 600, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '8px 22px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', transition: 'all 0.2s' }}>ì·¨ì†Œ</button>
              <button onClick={handleSendMessage} disabled={!messageText} style={{ fontWeight: 600, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '8px 22px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', opacity: messageText ? 1 : 0.5, cursor: messageText ? 'pointer' : 'not-allowed', transition: 'all 0.2s' }}>ë³´ë‚´ê¸°</button>
            </div>
          </div>
        </div>
      )}
      {/* í€˜ìŠ¤íŠ¸ ëª¨ë‹¬ */}
      {showQuestModal && (
        <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.3)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
          <div style={{ background: '#fff', padding: '32px 28px 24px 28px', borderRadius: 28, minWidth: 320, boxShadow: '0 4px 32px #b2ebf240', maxWidth: '90vw' }}>
            <div style={{ fontWeight: 700, fontSize: '1.25rem', marginBottom: 18, color: '#1976d2', letterSpacing: '-0.5px' }}>í€˜ìŠ¤íŠ¸ ì£¼ê¸°</div>
            <input value={questText} onChange={e => setQuestText(e.target.value)} style={{ width: '100%', borderRadius: 14, border: '2px solid #e0f7fa', padding: 10, fontSize: 16, outline: 'none', marginBottom: 10, background: '#f7faf7', color: '#222', transition: 'border 0.2s', boxSizing: 'border-box' }} placeholder="í€˜ìŠ¤íŠ¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" />
            <input type="number" value={questExp} onChange={e => setQuestExp(Number(e.target.value))} min={1} max={100} style={{ width: '100%', borderRadius: 14, border: '2px solid #e0f7fa', padding: 10, fontSize: 16, outline: 'none', marginBottom: 18, background: '#f7faf7', color: '#222', transition: 'border 0.2s', boxSizing: 'border-box' }} placeholder="ê²½í—˜ì¹˜" />
            <div style={{ marginTop: 0, textAlign: 'right', display: 'flex', gap: 10, justifyContent: 'flex-end' }}>
              <button onClick={() => setShowQuestModal(false)} style={{ fontWeight: 600, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '8px 22px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', transition: 'all 0.2s' }}>ì·¨ì†Œ</button>
              <button onClick={handleSendQuest} disabled={!questText || !questExp} style={{ fontWeight: 600, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '8px 22px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', opacity: questText && questExp ? 1 : 0.5, cursor: questText && questExp ? 'pointer' : 'not-allowed', transition: 'all 0.2s' }}>ë³´ë‚´ê¸°</button>
            </div>
          </div>
        </div>
      )}
      {/* ì¢…(ì•Œë¦¼) ë²„íŠ¼ UI */}
      <div style={{ position: 'fixed', top: 24, right: 32, zIndex: 2000, display: 'flex', flexDirection: 'row', gap: 18, alignItems: 'center' }}>
        {/* ìœ ë¦¬ë³‘ ì•„ì´ì½˜ ë²„íŠ¼ */}
        <div style={{ width: 40, height: 40, display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', position: 'relative' }} title="í•™ê¸‰ ìº”ë”” ìœ ë¦¬ë³‘" onClick={() => setShowJarModal(true)}>
          <img src="/jar2.png" alt="ìœ ë¦¬ë³‘" style={{ width: 32, height: 32, objectFit: 'contain', filter: 'drop-shadow(0 2px 6px #b2ebf2a0)' }} />
        </div>
        {/* ì¢…(ì•Œë¦¼) ë²„íŠ¼ */}
        <div style={{ width: 40, height: 40, display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', position: 'relative' }} title="í•™ìƒ ìš”ì²­ ì•Œë¦¼" onClick={() => setShowTeacherAlarm(true)}>
          <NotificationsActiveIcon fontSize="large" color="primary" />
          {pendingRequests.length > 0 && (
            <span style={{ position: 'absolute', top: 2, right: 2, background: '#ff1744', color: '#fff', borderRadius: '50%', width: 22, height: 22, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 13, fontWeight: 'bold', boxShadow: '0 1px 4px rgba(0,0,0,0.15)' }}>
              {pendingRequests.length}
            </span>
          )}
        </div>
        <button onClick={()=>setShowBankModal(true)} style={{ background: '#fffde7', border: 'none', borderRadius: 999, padding: '8px 18px', boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 8 }}>
          <StorefrontIcon style={{ color: '#d72660', fontSize: 28 }} />
          <span style={{ fontWeight: 700, color: '#d72660', fontSize: 16 }}>ìº”ë””ìˆ</span>
        </button>
      </div>
      {/* ì•Œë¦¼ ëª¨ë‹¬ UI */}
      {showTeacherAlarm && (
        <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.3)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 3000 }}>
          <div style={{ background: '#fff', padding: '32px 28px 24px 28px', borderRadius: 28, minWidth: 420, maxHeight: 600, overflowY: 'auto', boxShadow: '0 4px 32px #b2ebf240', maxWidth: '90vw' }}>
            <div style={{ fontWeight: 700, fontSize: '1.25rem', marginBottom: 18, color: '#1976d2', letterSpacing: '-0.5px' }}>í•™ìƒ ìš”ì²­ ì•Œë¦¼</div>
            <div style={{ display: 'flex', gap: 12, marginBottom: 16 }}>
              <button onClick={() => setAlarmTab('message')} style={{ fontWeight: alarmTab==='message'?700:500, borderRadius: 999, background: alarmTab==='message' ? '#e0f7fa' : '#f7faf7', color: '#1976d2', border: 'none', padding: '7px 18px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', transition: 'all 0.2s' }}>ë©”ì‹œì§€</button>
              <button onClick={() => setAlarmTab('praise')} style={{ fontWeight: alarmTab==='praise'?700:500, borderRadius: 999, background: alarmTab==='praise' ? '#e0f7fa' : '#f7faf7', color: '#1976d2', border: 'none', padding: '7px 18px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', transition: 'all 0.2s' }}>ì¹­ì°¬ ìš”ì²­</button>
              <button onClick={() => setAlarmTab('historyMessage')} style={{ fontWeight: alarmTab==='historyMessage'?700:500, borderRadius: 999, background: alarmTab==='historyMessage' ? '#e0f7fa' : '#f7faf7', color: '#1976d2', border: 'none', padding: '7px 18px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', transition: 'all 0.2s' }}>ê³¼ê±° ë©”ì‹œì§€</button>
              <button onClick={() => setAlarmTab('historyPraise')} style={{ fontWeight: alarmTab==='historyPraise'?700:500, borderRadius: 999, background: alarmTab==='historyPraise' ? '#e0f7fa' : '#f7faf7', color: '#1976d2', border: 'none', padding: '7px 18px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', transition: 'all 0.2s' }}>ê³¼ê±° ì¹­ì°¬</button>
            </div>
            {alarmTab === 'message' && (
              <>
                <div style={{ textAlign: 'right', marginBottom: 8 }}>
                  <button onClick={() => handleMarkAllAsRead('message')} style={{ fontWeight: 600, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '6px 18px', fontSize: 14, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', transition: 'all 0.2s' }}>ëª¨ë‘ ì½ìŒ</button>
                </div>
                <ul style={{ listStyle: 'none', padding: 0, margin: 0 }}>
                  {pendingRequests.filter(r => r.type === 'message').length === 0 && <li style={{ color: '#888', padding: '18px 0', textAlign: 'center' }}>ìƒˆë¡œìš´ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</li>}
                  {pendingRequests.filter(r => r.type === 'message').map((req, idx) => (
                    <li key={idx} style={{ marginBottom: 16, borderBottom: '1px solid #e0f7fa', paddingBottom: 8, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <div>
                        <div style={{ fontWeight: 600, marginBottom: 4, color: '#1976d2' }}>{req.studentName} (ë©”ì‹œì§€)</div>
                        <div style={{ marginBottom: 4, color: '#222' }}>{req.text}</div>
                        <div style={{ color: '#90caf9', fontSize: 13 }}>{new Date(req.ts).toLocaleString()}</div>
                      </div>
                      <button onClick={() => handleMarkAsRead(req)} style={{ fontWeight: 600, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '6px 14px', fontSize: 14, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', transition: 'all 0.2s' }}>ì½ìŒ</button>
                    </li>
                  ))}
                </ul>
              </>
            )}
            {alarmTab === 'praise' && (
              <>
                <div style={{ textAlign: 'right', marginBottom: 8 }}>
                  <button onClick={() => handleMarkAllAsRead('praise')} style={{ fontWeight: 600, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '6px 18px', fontSize: 14, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', transition: 'all 0.2s' }}>ëª¨ë‘ ì½ìŒ</button>
                </div>
                <ul style={{ listStyle: 'none', padding: 0, margin: 0 }}>
                  {pendingRequests.filter(r => r.type === 'friendPraise' || r.type === 'selfPraise').length === 0 && <li style={{ color: '#888', padding: '18px 0', textAlign: 'center' }}>ìƒˆë¡œìš´ ì¹­ì°¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</li>}
                  {pendingRequests.filter(r => r.type === 'friendPraise' || r.type === 'selfPraise').map((req, idx) => (
                    <li key={idx} style={{ marginBottom: 16, borderBottom: '1px solid #e0f7fa', paddingBottom: 8, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <div>
                        <div style={{ fontWeight: 600, marginBottom: 4, color: '#1976d2' }}>{req.studentName} ({req.type === 'friendPraise' ? 'ì¹œêµ¬ ì¹­ì°¬' : 'ë‚˜ ì¹­ì°¬'})</div>
                        <div style={{ marginBottom: 4, color: '#222' }}>{req.text}</div>
                        <div style={{ color: '#90caf9', fontSize: 13 }}>{new Date(req.ts).toLocaleString()}</div>
                        <div>í¬ë§ ê²½í—˜ì¹˜: {req.exp}</div>
                      </div>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>
                        <button onClick={() => handleApprove(req)} style={{ fontWeight: 600, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '6px 14px', fontSize: 14, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', marginBottom: 4 }}>ìŠ¹ì¸</button>
                        <button onClick={() => { setSelectedRequest(req); }} style={{ fontWeight: 600, borderRadius: 999, background: '#ffe4ec', color: '#d72660', border: 'none', padding: '6px 14px', fontSize: 14, boxShadow: '0 2px 8px #f8bbd0a0', cursor: 'pointer' }}>ê±°ì ˆ</button>
                      </div>
                    </li>
                  ))}
                </ul>
              </>
            )}
            {alarmTab === 'historyMessage' && (
              <>
                <div style={{ fontWeight: 600, marginBottom: 8, color: '#1976d2', textAlign: 'center' }}>ëª¨ë“  í•™ìƒì˜ ë©”ì‹œì§€ ë‚´ì—­</div>
                <ul style={{ listStyle: 'none', padding: 0, margin: 0, maxHeight: 350, overflowY: 'auto' }}>
                  {studentsSnapshot && studentsSnapshot.docs.flatMap(doc => {
                    const student = doc.data();
                    return (student.messages || []).map((msg, idx) => ({
                      studentName: student.name,
                      text: msg.text,
                      ts: msg.ts,
                      checked: msg.checked,
                    }));
                  }).sort((a, b) => b.ts - a.ts).map((msg, idx) => (
                    <li key={idx} style={{ marginBottom: 12, borderBottom: '1px solid #e0f7fa', paddingBottom: 6 }}>
                      <div style={{ fontWeight: 600, color: '#1976d2' }}>{msg.studentName}</div>
                      <div style={{ color: '#222', marginBottom: 2 }}>{msg.text}</div>
                      <div style={{ color: '#90caf9', fontSize: 13 }}>{new Date(msg.ts).toLocaleString()}</div>
                      <div style={{ color: msg.checked ? '#43a047' : '#ff9800', fontSize: 13 }}>{msg.checked ? 'ì½ìŒ' : 'ë¯¸í™•ì¸'}</div>
                    </li>
                  ))}
                </ul>
              </>
            )}
            {alarmTab === 'historyPraise' && (
              <>
                <div style={{ fontWeight: 600, marginBottom: 8, color: '#1976d2', textAlign: 'center' }}>ëª¨ë“  í•™ìƒì˜ ì¹­ì°¬ ë‚´ì—­</div>
                <ul style={{ listStyle: 'none', padding: 0, margin: 0, maxHeight: 350, overflowY: 'auto' }}>
                  {studentsSnapshot && studentsSnapshot.docs.flatMap(doc => {
                    const student = doc.data();
                    return (student.praise || []).map((p, idx) => ({
                      studentName: student.name,
                      text: p.text,
                      ts: p.ts,
                      checked: p.checked,
                      result: p.result,
                      reason: p.reason,
                      self: p.self,
                      friends: p.friends,
                    }));
                  }).sort((a, b) => b.ts - a.ts).map((p, idx) => {
                    let targetText = '';
                    if (p.self) {
                      targetText = `${p.studentName} (ë‚˜ ì¹­ì°¬)`;
                    } else if (Array.isArray(p.friends) && p.friends.length > 0 && studentsSnapshot) {
                      const friendNames = p.friends.map(fid => {
                        const fdoc = studentsSnapshot.docs.find(d => d.id === fid);
                        return fdoc ? fdoc.data().name : fid;
                      });
                      targetText = `${p.studentName} â†’ ${friendNames.join(', ')}`;
                    } else {
                      targetText = p.studentName;
                    }
                    return (
                      <li key={idx} style={{ marginBottom: 12, borderBottom: '1px solid #e0f7fa', paddingBottom: 6 }}>
                        <div style={{ fontWeight: 600, color: '#1976d2' }}>{targetText}</div>
                        <div style={{ color: '#222', marginBottom: 2 }}>{p.text}</div>
                        <div style={{ color: '#90caf9', fontSize: 13 }}>{new Date(p.ts).toLocaleString()}</div>
                        <div style={{ color: p.checked ? (p.result === 'approved' ? '#43a047' : '#ff1744') : '#ff9800', fontSize: 13 }}>
                          {p.checked ? (p.result === 'approved' ? 'ìŠ¹ì¸' : (p.result === 'rejected' ? `ê±°ì ˆ (${p.reason||''})` : 'ì²˜ë¦¬ë¨')) : 'ë¯¸í™•ì¸'}
                        </div>
                      </li>
                    );
                  })}
                </ul>
              </>
            )}
            <div style={{ marginTop: 16, textAlign: 'right' }}>
              <button onClick={() => setShowTeacherAlarm(false)} style={{ fontWeight: 600, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '8px 22px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', transition: 'all 0.2s' }}>ë‹«ê¸°</button>
            </div>
          </div>
          {/* ìŠ¹ì¸/ê±°ì ˆ ëª¨ë‹¬ */}
          {selectedRequest && (
            <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.3)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 4000 }}>
              <div style={{ background: '#fff', padding: 32, borderRadius: 16, minWidth: 320 }}>
                <h3>ìš”ì²­ ì²˜ë¦¬</h3>
                <div style={{ marginBottom: 12 }}>{selectedRequest.text}</div>
                {(selectedRequest.type === 'friendPraise' || selectedRequest.type === 'selfPraise') && <div>í¬ë§ ê²½í—˜ì¹˜: {selectedRequest.exp}</div>}
                <div style={{ marginTop: 16, textAlign: 'right' }}>
                  <button onClick={() => handleApprove(selectedRequest)} style={{ marginRight: 8 }}>ìŠ¹ì¸</button>
                  <input value={rejectReason} onChange={e => setRejectReason(e.target.value)} placeholder="ê±°ì ˆ ì‚¬ìœ " style={{ marginRight: 8 }} />
                  <button onClick={() => handleReject(selectedRequest)} disabled={!rejectReason}>ê±°ì ˆ</button>
                  <button onClick={() => setSelectedRequest(null)} style={{ marginLeft: 8 }}>ì·¨ì†Œ</button>
                </div>
              </div>
            </div>
          )}
        </div>
      )}
      {/* í€˜ìŠ¤íŠ¸ ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‹¬ */}
      {questActionStudent && questActionQuest && (
        <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.3)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 2000 }}>
          <div style={{ background: '#fff', padding: 32, borderRadius: 16, minWidth: 320 }}>
            <h3>í€˜ìŠ¤íŠ¸ ê²°ê³¼</h3>
            <div style={{ marginBottom: 12 }}><b>{questActionStudent.name}</b>ì˜ í€˜ìŠ¤íŠ¸: <b>{questActionQuest.text}</b></div>
            <div style={{ marginBottom: 12 }}>ë³´ìƒ: {questActionQuest.exp}xp</div>
            <div style={{ display: 'flex', gap: 12, justifyContent: 'center', marginTop: 16 }}>
              <button onClick={() => handleQuestResult(questActionStudent.id, questActionQuest, 'success')} style={{ background: '#43a047', color: '#fff', fontWeight: 'bold', borderRadius: 8, padding: '8px 24px' }}>ì„±ê³µ</button>
              <button onClick={() => handleQuestResult(questActionStudent.id, questActionQuest, 'fail')} style={{ background: '#ff1744', color: '#fff', fontWeight: 'bold', borderRadius: 8, padding: '8px 24px' }}>ì‹¤íŒ¨</button>
              <button onClick={() => { setQuestActionStudent(null); setQuestActionQuest(null); }} style={{ marginLeft: 8 }}>ì·¨ì†Œ</button>
            </div>
          </div>
        </div>
      )}
      {/* í€˜ìŠ¤íŠ¸ ê²°ê³¼ ì´í™íŠ¸ */}
      {questResultEffect && (
        <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 3000, pointerEvents: 'none' }}>
          <div style={{ fontSize: 32, color: '#43a047', background: 'rgba(255,255,255,0.95)', borderRadius: 24, padding: '32px 48px', boxShadow: '0 4px 24px rgba(0,0,0,0.12)', animation: 'pop 1.5s' }}>
            {questResultEffect}
          </div>
        </div>
      )}
      {/* ìœ ë¦¬ë³‘ ëª¨ë‹¬ */}
      {showJarModal && (
        <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.3)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 4000 }}>
          <div style={{ background: '#fff', padding: 32, borderRadius: 48, minWidth: 340, boxShadow: '0 4px 32px #b2ebf240', maxWidth: '90vw', position: 'relative', border: '6px solid #b2ebf2' }}>
            <div style={{ fontWeight: 700, fontSize: '1.5rem', marginBottom: 18, color: '#1976d2', letterSpacing: '-0.5px', textAlign: 'center' }}>í•™ê¸‰ ìº”ë”” ìœ ë¦¬ë³‘</div>
            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: 12 }}>
              {/* ì‚¬íƒ• ê·¸ë¦¬ë“œí˜• ë°°ì¹˜ */}
              {(() => {
                // ëª¨ë“  ì‚¬íƒ•ì„ í•œ ë°°ì—´ë¡œ í•©ì¹¨
                const allCandies = [];
                candyCounts.forEach((count, idx) => {
                  for (let i = 0; i < count; i++) {
                    allCandies.push({ img: candyImages[idx], idx });
                  }
                });
                const perRow = 10;
                const numRows = Math.ceil(allCandies.length / perRow);
                return (
                  <div style={{ width: 320, height: 380, marginBottom: 8, display: 'flex', flexDirection: 'column-reverse', justifyContent: 'flex-start', alignItems: 'center', gap: 4 }}>
                    {Array.from({ length: numRows }).map((_, rowIdx) => (
                      <div key={rowIdx} style={{ display: 'flex', flexDirection: 'row', justifyContent: 'flex-start', alignItems: 'flex-end', gap: 4, minHeight: 36 }}>
                        {Array.from({ length: perRow }).map((_, colIdx) => {
                          const candy = allCandies[rowIdx * perRow + colIdx];
                          return candy ? (
                            <img key={colIdx} src={candy.img} alt={`candy${candy.idx+1}`} style={{ width: 32, height: 32, filter: 'drop-shadow(0 2px 6px #b2ebf2a0)' }} />
                          ) : <div key={colIdx} style={{ width: 32, height: 32 }} />;
                        })}
                      </div>
                    ))}
                  </div>
                );
              })()}
              <div style={{ display: 'flex', gap: 12, marginTop: 2 }}>
                {candyCounts.map((count, idx) => (
                  <div key={idx} style={{ display: 'flex', alignItems: 'center', gap: 4, fontWeight: 600, color: '#1976d2', fontSize: 15 }}>
                    <img src={candyImages[idx]} alt={`candy${idx+1}`} style={{ width: 22, height: 22, marginRight: 2 }} />
                    x{count}
                  </div>
                ))}
              </div>
              <div style={{ color: '#888', fontSize: 13, marginTop: 4 }}>í•™ìƒë“¤ì´ ë ˆë²¨ì—…í•  ë•Œë§ˆë‹¤ ì‚¬íƒ•ì´ ìœ ë¦¬ë³‘ì— ìŒ“ì—¬ìš”!</div>
            </div>
            <div style={{ textAlign: 'center', marginTop: 18 }}>
              <button onClick={() => setShowJarModal(false)} style={{ fontWeight: 600, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '8px 32px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', transition: 'all 0.2s' }}>ë‹«ê¸°</button>
            </div>
          </div>
        </div>
      )}
      {/* ê²Œì‹œíŒ ì„ íƒ(1ì°¨) ëª¨ë‹¬ */}
      {showBoardChoiceModal && (
        <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.3)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 3000 }}>
          <div style={{ background: '#fff', padding: 32, borderRadius: 24, minWidth: 340, maxWidth: 420, boxShadow: '0 4px 32px #b2ebf240', textAlign: 'center' }}>
            <div style={{ fontWeight: 700, fontSize: '1.15rem', marginBottom: 18, color: '#1976d2' }}>ê²Œì‹œíŒì„ ì„ íƒí•˜ì„¸ìš”</div>
            <div style={{ display: 'flex', gap: 16, justifyContent: 'center', marginBottom: 18 }}>
              <button onClick={() => { setShowBoardChoiceModal(false); setShowBoardListModal(true); fetchBoardList(); }} style={{ fontWeight: 600, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '12px 32px', fontSize: 16, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', transition: 'all 0.2s' }}>ê¸°ì¡´ ê²Œì‹œíŒ ë¶ˆëŸ¬ì˜¤ê¸°</button>
              <button onClick={() => { setShowBoardChoiceModal(false); setShowCreateBoardModal(true); }} style={{ fontWeight: 600, borderRadius: 999, background: '#ffe4ec', color: '#d72660', border: 'none', padding: '12px 32px', fontSize: 16, boxShadow: '0 2px 8px #f8bbd0a0', cursor: 'pointer', transition: 'all 0.2s' }}>ìƒˆ ê²Œì‹œíŒ ë§Œë“¤ê¸°</button>
            </div>
            <button onClick={() => setShowBoardChoiceModal(false)} style={{ fontWeight: 600, borderRadius: 999, background: '#f7faf7', color: '#888', border: 'none', padding: '8px 32px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', transition: 'all 0.2s' }}>ì·¨ì†Œ</button>
          </div>
        </div>
      )}
      {/* ê²Œì‹œíŒ ëª©ë¡ ëª¨ë‹¬ */}
      {showBoardListModal && (
        <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.3)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 3000 }}>
          <div style={{ background: '#fff', padding: 32, borderRadius: 24, minWidth: 340, maxWidth: 480, boxShadow: '0 4px 32px #b2ebf240', textAlign: 'center' }}>
            <div style={{ fontWeight: 700, fontSize: '1.15rem', marginBottom: 18, color: '#1976d2' }}>ê²Œì‹œíŒ ëª©ë¡</div>
            {boardListLoading ? (
              <div style={{ color: '#888', margin: '24px 0' }}>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            ) : (
              boardList.length === 0 ? (
                <div style={{ color: '#aaa', margin: '24px 0' }}>ì•„ì§ ìƒì„±ëœ ê²Œì‹œíŒì´ ì—†ìŠµë‹ˆë‹¤.</div>
              ) : (
                <ul style={{ listStyle: 'none', padding: 0, margin: 0, maxHeight: 320, overflowY: 'auto' }}>
                  {boardList.map(board => (
                    <li key={board.id} style={{ marginBottom: 18, borderBottom: '1.5px dashed #e0f7fa', paddingBottom: 12 }}>
                      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: 12 }}>
                        <div style={{ textAlign: 'left' }}>
                          <div style={{ fontWeight: 600, fontSize: 18, color: '#1976d2' }}>{board.title ? board.title : `ê²Œì‹œíŒ #${board.code}`}</div>
                          <div style={{ fontSize: 14, color: '#888', marginTop: 2 }}>ì½”ë“œ: <span style={{fontWeight:600}}>{board.code}</span></div>
                          <div style={{ fontSize: 13, color: '#bbb', marginTop: 2 }}>{board.createdAt && board.createdAt.toDate ? board.createdAt.toDate().toLocaleString() : ''}</div>
                        </div>
                        <button onClick={() => { setShowBoardListModal(false); navigate(`/board/${board.code}`); }} style={{ fontWeight: 600, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '8px 22px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', transition: 'all 0.2s' }}>ì…ì¥</button>
                      </div>
                    </li>
                  ))}
                </ul>
              )
            )}
            <div style={{ marginTop: 18, display: 'flex', gap: 10, justifyContent: 'center' }}>
              <button onClick={() => { setShowBoardListModal(false); setShowBoardCodeModal(true); }} style={{ fontWeight: 600, borderRadius: 999, background: '#f7faf7', color: '#1976d2', border: 'none', padding: '8px 32px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', transition: 'all 0.2s' }}>ì½”ë“œë¡œ ì§ì ‘ ì…ì¥</button>
              <button onClick={() => setShowBoardListModal(false)} style={{ fontWeight: 600, borderRadius: 999, background: '#ffe4ec', color: '#d72660', border: 'none', padding: '8px 32px', fontSize: 15, boxShadow: '0 2px 8px #f8bbd0a0', cursor: 'pointer', transition: 'all 0.2s' }}>ë‹«ê¸°</button>
            </div>
          </div>
        </div>
      )}
      {/* ê²Œì‹œíŒ ì½”ë“œ ì…ë ¥ ëª¨ë‹¬ */}
      {showBoardCodeModal && (
        <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.3)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 3000 }}>
          <div style={{ background: '#fff', padding: 32, borderRadius: 24, minWidth: 340, maxWidth: 420, boxShadow: '0 4px 32px #b2ebf240', textAlign: 'center' }}>
            <div style={{ fontWeight: 700, fontSize: '1.15rem', marginBottom: 18, color: '#1976d2' }}>ê²Œì‹œíŒ ì½”ë“œ ì…ë ¥</div>
            <input value={boardCodeInput} onChange={e => setBoardCodeInput(e.target.value)} maxLength={8} style={{ width: '100%', borderRadius: 14, border: '2px solid #e0f7fa', padding: 12, fontSize: 16, outline: 'none', marginBottom: 18, background: '#f7faf7', color: '#222', transition: 'border 0.2s', boxSizing: 'border-box', textAlign: 'center', letterSpacing: 2, fontWeight: 600 }} placeholder="ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
            <div style={{ display: 'flex', gap: 10, justifyContent: 'center', marginTop: 8 }}>
              <button onClick={() => { setShowBoardCodeModal(false); setBoardCodeInput(''); }} style={{ fontWeight: 600, borderRadius: 999, background: '#ffe4ec', color: '#d72660', border: 'none', padding: '8px 32px', fontSize: 15, boxShadow: '0 2px 8px #f8bbd0a0', cursor: 'pointer', transition: 'all 0.2s' }}>ì·¨ì†Œ</button>
              <button onClick={() => { if(boardCodeInput.trim()){ setShowBoardCodeModal(false); setBoardCodeInput(''); navigate(`/board/${boardCodeInput.trim().toUpperCase()}`); }}} disabled={!boardCodeInput.trim()} style={{ fontWeight: 600, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '8px 32px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', opacity: boardCodeInput.trim() ? 1 : 0.5, cursor: boardCodeInput.trim() ? 'pointer' : 'not-allowed', transition: 'all 0.2s' }}>ì…ì¥</button>
            </div>
          </div>
        </div>
      )}
      {/* ê²Œì‹œíŒ ê°œì„¤ ëª¨ë‹¬ */}
      {showCreateBoardModal && (
        <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.3)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 3000 }}>
          <div style={{ background: '#fff', padding: 32, borderRadius: 24, minWidth: 340, maxWidth: 420, boxShadow: '0 4px 32px #b2ebf240', textAlign: 'center' }}>
            <div style={{ fontWeight: 700, fontSize: '1.15rem', marginBottom: 18, color: '#1976d2' }}>ê²Œì‹œíŒ ì œëª© ì…ë ¥</div>
            <input value={newBoardTitle} onChange={e => setNewBoardTitle(e.target.value)} maxLength={30} style={{ width: '100%', borderRadius: 14, border: '2px solid #e0f7fa', padding: 12, fontSize: 16, outline: 'none', marginBottom: 18, background: '#f7faf7', color: '#222', transition: 'border 0.2s', boxSizing: 'border-box', textAlign: 'center', fontWeight: 600 }} placeholder="ì˜ˆ: ì˜¤ëŠ˜ì˜ ì•„ì´ë””ì–´" />
            <div style={{ display: 'flex', gap: 10, justifyContent: 'center', marginTop: 8 }}>
              <button onClick={() => setShowCreateBoardModal(false)} style={{ fontWeight: 600, borderRadius: 999, background: '#ffe4ec', color: '#d72660', border: 'none', padding: '8px 32px', fontSize: 15, boxShadow: '0 2px 8px #f8bbd0a0', cursor: 'pointer', transition: 'all 0.2s' }}>ì·¨ì†Œ</button>
              <button onClick={handleCreateBoard} disabled={!newBoardTitle.trim()} style={{ fontWeight: 600, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '8px 32px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', opacity: newBoardTitle.trim() ? 1 : 0.5, cursor: newBoardTitle.trim() ? 'pointer' : 'not-allowed', transition: 'all 0.2s' }}>ê°œì„¤</button>
            </div>
          </div>
        </div>
      )}
      {/* ìº”ë””ìˆ(í•™ê¸‰ ì€í–‰) ëª¨ë‹¬ */}
      {showBankModal && (
        <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.3)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 3000 }}>
          <div style={{ background: '#fff', padding: 40, borderRadius: 32, minWidth: 520, maxWidth: 720, boxShadow: '0 8px 48px #b2ebf240', textAlign: 'center', position: 'relative' }}>
            <button onClick={()=>setShowBankModal(false)} style={{ position: 'absolute', top: 18, right: 18, background: 'none', border: 'none', fontSize: 28, color: '#bbb', cursor: 'pointer', fontWeight: 700 }}>Ã—</button>
            <div style={{ display: 'flex', justifyContent: 'center', gap: 24, marginBottom: 32 }}>
              <button onClick={()=>setBankTab('balance')} style={{ fontWeight: 700, fontSize: 18, color: bankTab==='balance' ? '#d72660' : '#888', background: 'none', border: 'none', borderBottom: bankTab==='balance' ? '3px solid #d72660' : '3px solid #eee', padding: '8px 24px', cursor: 'pointer', transition: 'all 0.2s' }}>í•™ìƒ ìº”ë””ìˆ ì¬ì‚°ìƒí™©</button>
              <button onClick={()=>setBankTab('items')} style={{ fontWeight: 700, fontSize: 18, color: bankTab==='items' ? '#d72660' : '#888', background: 'none', border: 'none', borderBottom: bankTab==='items' ? '3px solid #d72660' : '3px solid #eee', padding: '8px 24px', cursor: 'pointer', transition: 'all 0.2s' }}>í’ˆëª©ëª…</button>
              <button onClick={()=>setBankTab('deposit')} style={{ fontWeight: 700, fontSize: 18, color: bankTab==='deposit' ? '#d72660' : '#888', background: 'none', border: 'none', borderBottom: bankTab==='deposit' ? '3px solid #d72660' : '3px solid #eee', padding: '8px 24px', cursor: 'pointer', transition: 'all 0.2s' }}>ì…ê¸ˆë‚´ì—­</button>
              <button onClick={()=>setBankTab('withdraw')} style={{ fontWeight: 700, fontSize: 18, color: bankTab==='withdraw' ? '#d72660' : '#888', background: 'none', border: 'none', borderBottom: bankTab==='withdraw' ? '3px solid #d72660' : '3px solid #eee', padding: '8px 24px', cursor: 'pointer', transition: 'all 0.2s' }}>ì§€ì¶œë‚´ì—­</button>
            </div>
            {/* íƒ­ë³„ ë‚´ìš© - 1ì°¨ëŠ” ë¹ˆ í™”ë©´ */}
            {bankTab==='balance' && (
              <div style={{ minHeight: 220, padding: 10, display: 'flex', justifyContent: 'center' }}>
                <div style={{ background: '#f7faf7', borderRadius: 18, boxShadow: '0 2px 12px #b2ebf220', padding: 24, maxWidth: 480, width: '100%', overflowX: 'auto' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 18 }}>
                    <div style={{ fontWeight: 700, fontSize: 20, color: '#1976d2' }}>í•™ìƒë³„ ì”ì•¡</div>
                    <div style={{ display: 'flex', gap: 8 }}>
                      <button onClick={() => {
                        if (bankSelectedIds.length === studentsSnapshot.docs.length) setBankSelectedIds([]);
                        else setBankSelectedIds(studentsSnapshot.docs.map(doc=>doc.id));
                      }} style={{ borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '6px 18px', fontWeight: 600, fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer' }}>{bankSelectedIds.length === studentsSnapshot.docs.length ? 'ì „ì²´ í•´ì œ' : 'ì „ì²´ ì„ íƒ'}</button>
                      <button
                        onClick={() => {
                          setAmountType('deposit');
                          setShowAmountModal(true);
                        }}
                        disabled={bankSelectedIds.length === 0}
                        style={{ ...buttonStyle, background: '#e0f7fa', color: '#43a047', border: 'none', opacity: bankSelectedIds.length === 0 ? 0.5 : 1 }}
                      >ì…ê¸ˆ</button>
                      <button
                        onClick={() => {
                          setAmountType('withdraw');
                          setShowAmountModal(true);
                        }}
                        disabled={bankSelectedIds.length === 0}
                        style={{ ...buttonStyle, background: '#ffe4ec', color: '#d72660', border: 'none', opacity: bankSelectedIds.length === 0 ? 0.5 : 1 }}
                      >ì¶œê¸ˆ</button>
                      <button onClick={()=>setShowAddStudentModal(true)} style={{ borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '6px 18px', fontWeight: 600, fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer' }}>í•™ìƒ ì¶”ê°€</button>
                    </div>
                  </div>
                  <div style={{ maxHeight: 420, overflowY: 'auto' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse', background: '#f7faf7', borderRadius: 16, overflow: 'hidden', fontSize: 16 }}>
                      <thead>
                        <tr style={{ background: '#e0f7fa', color: '#1976d2', fontWeight: 700 }}>
                          <th style={{ padding: 8 }}>ì„ íƒ</th>
                          <th style={{ padding: 8 }}>ì´ë¦„</th>
                          <th style={{ padding: 8 }}>ì”ì•¡</th>
                          <th style={{ padding: 8 }}>ì‚­ì œ</th>
                        </tr>
                      </thead>
                      <tbody>
                        {studentRows.map(row => (
                          <tr key={row.id} style={{ borderBottom: '1px solid #e0f7fa' }}>
                            <td style={{ textAlign: 'center' }}>
                              <input type="checkbox" checked={bankSelectedIds.includes(row.id)} onChange={() => {
                                setBankSelectedIds(ids => ids.includes(row.id) ? ids.filter(i => i !== row.id) : [...ids, row.id]);
                              }} />
                            </td>
                            <td style={{ fontWeight: 600, color: '#1976d2', padding: 8 }}>
                              <input type="text" value={bankNames[row.id] ?? row.name ?? ''} onChange={e => {
                                setBankNames(n => ({ ...n, [row.id]: e.target.value }));
                              }} style={{ width: 90, borderRadius: 8, border: '1.5px solid #e0f7fa', padding: '6px 10px', fontSize: 16, background: '#fff', color: '#222', fontWeight: 600 }} />
                            </td>
                            <td style={{ padding: 8 }}>
                              <input type="number" value={bankBalances[row.id] ?? row.balance ?? 0} onChange={e => {
                                const v = parseInt(e.target.value) || 0;
                                setBankBalances(b => ({ ...b, [row.id]: v }));
                              }} style={{ width: 80, borderRadius: 8, border: '1.5px solid #e0f7fa', padding: '6px 10px', fontSize: 16, background: '#fff', color: '#222', textAlign: 'right', fontWeight: 600 }} />
                            </td>
                            <td style={{ textAlign: 'center' }}>
                              <button onClick={async () => {
                                if (window.confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                  await deleteDoc(doc(db, 'students', row.id));
                                }
                              }} style={{ background: '#ffe4ec', color: '#d72660', border: 'none', borderRadius: 8, padding: '4px 14px', fontWeight: 600, fontSize: 14, cursor: 'pointer' }}>ì‚­ì œ</button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                  {/* í•™ìƒ ì¶”ê°€ ëª¨ë‹¬ */}
                  {showAddStudentModal && (
                    <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.3)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 4000 }}>
                      <div style={{ background: '#fff', padding: 32, borderRadius: 24, minWidth: 320, maxWidth: 400, boxShadow: '0 4px 32px #b2ebf240', textAlign: 'center' }}>
                        <div style={{ fontWeight: 700, fontSize: '1.15rem', marginBottom: 18, color: '#1976d2' }}>í•™ìƒ ì¶”ê°€</div>
                        <input type="text" value={newStudentName} onChange={e=>setNewStudentName(e.target.value)} placeholder="ì´ë¦„" style={{ width: '100%', borderRadius: 14, border: '2px solid #e0f7fa', padding: 12, fontSize: 16, outline: 'none', marginBottom: 12, background: '#f7faf7', color: '#222', transition: 'border 0.2s', boxSizing: 'border-box', textAlign: 'center', fontWeight: 600 }} />
                        <input type="number" value={newStudentBalance} onChange={e=>setNewStudentBalance(Number(e.target.value)||0)} placeholder="ì”ì•¡" style={{ width: '100%', borderRadius: 14, border: '2px solid #e0f7fa', padding: 12, fontSize: 16, outline: 'none', marginBottom: 18, background: '#f7faf7', color: '#222', transition: 'border 0.2s', boxSizing: 'border-box', textAlign: 'center', fontWeight: 600 }} />
                        <div style={{ display: 'flex', gap: 10, justifyContent: 'center', marginTop: 8 }}>
                          <button onClick={()=>setShowAddStudentModal(false)} style={{ fontWeight: 600, borderRadius: 999, background: '#ffe4ec', color: '#d72660', border: 'none', padding: '8px 32px', fontSize: 15, boxShadow: '0 2px 8px #f8bbd0a0', cursor: 'pointer', transition: 'all 0.2s' }}>ì·¨ì†Œ</button>
                          <button onClick={async()=>{
                            if(!newStudentName.trim()) return;
                            await setDoc(doc(db, 'students', newStudentName), { name: newStudentName.trim(), balance: newStudentBalance });
                            setShowAddStudentModal(false);
                            setNewStudentName('');
                            setNewStudentBalance(0);
                          }} disabled={!newStudentName.trim()} style={{ fontWeight: 600, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '8px 32px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', opacity: newStudentName.trim() ? 1 : 0.5, cursor: newStudentName.trim() ? 'pointer' : 'not-allowed', transition: 'all 0.2s' }}>ì¶”ê°€</button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )}
            {bankTab==='items' && (
              <div style={{ minHeight: 220, padding: 10 }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 18 }}>
                  <div style={{ fontWeight: 700, fontSize: 20, color: '#1976d2' }}>í’ˆëª©ëª…/ê°€ê²©</div>
                  <div style={{ display: 'flex', gap: 8 }}>
                    <button onClick={async()=>{
                      setItemSaving(true);
                      for(const id of Object.keys(itemNames)){
                        await setDoc(doc(db, 'items', id), { name: itemNames[id], price: itemPrices[id] });
                      }
                      setItemSaving(false);
                      alert('ì €ì¥ ì™„ë£Œ!');
                    }} style={{ borderRadius: 999, background: '#fffde7', color: '#1976d2', border: 'none', padding: '6px 18px', fontWeight: 600, fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', opacity: itemSaving?0.5:1 }}>{itemSaving?'ì €ì¥ì¤‘...':'ì €ì¥'}</button>
                    <button onClick={()=>setShowAddItemModal(true)} style={{ borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '6px 18px', fontWeight: 600, fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer' }}>í’ˆëª© ì¶”ê°€</button>
                  </div>
                </div>
                <table style={{ width: '100%', borderCollapse: 'collapse', background: '#f7faf7', borderRadius: 16, overflow: 'hidden', fontSize: 16 }}>
                  <thead>
                    <tr style={{ background: '#e0f7fa', color: '#1976d2', fontWeight: 700 }}>
                      <th style={{ padding: 8 }}>í’ˆëª©ëª…</th>
                      <th style={{ padding: 8 }}>ê°€ê²©</th>
                      <th style={{ padding: 8 }}>ì‚­ì œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    {items.map(item => (
                      <tr key={item.id} style={{ borderBottom: '1px solid #e0f7fa' }}>
                        <td style={{ fontWeight: 600, color: '#1976d2', padding: 8 }}>
                          <input type="text" value={itemNames[item.id]??''} onChange={e=>{
                            setItemNames(n=>({...n, [item.id]:e.target.value}));
                          }} style={{ width: 120, borderRadius: 8, border: '1.5px solid #e0f7fa', padding: '6px 10px', fontSize: 16, background: '#fff', color: '#222', fontWeight: 600 }} />
                        </td>
                        <td style={{ padding: 8 }}>
                          <input type="number" value={itemPrices[item.id]??0} onChange={e=>{
                            const v = parseInt(e.target.value)||0;
                            setItemPrices(p=>({...p, [item.id]:v}));
                          }} style={{ width: 80, borderRadius: 8, border: '1.5px solid #e0f7fa', padding: '6px 10px', fontSize: 16, background: '#fff', color: '#222', textAlign: 'right', fontWeight: 600 }} />
                        </td>
                        <td style={{ textAlign: 'center' }}>
                          <button onClick={async()=>{
                            if(window.confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
                              await deleteDoc(doc(db, 'items', item.id));
                              setItems(items=>items.filter(i=>i.id!==item.id));
                            }
                          }} style={{ background:'#ffe4ec', color:'#d72660', border:'none', borderRadius:8, padding:'4px 14px', fontWeight:600, fontSize:14, cursor:'pointer' }}>ì‚­ì œ</button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                {/* í’ˆëª© ì¶”ê°€ ëª¨ë‹¬ */}
                {showAddItemModal && (
                  <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.3)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 4000 }}>
                    <div style={{ background: '#fff', padding: 32, borderRadius: 24, minWidth: 320, maxWidth: 400, boxShadow: '0 4px 32px #b2ebf240', textAlign: 'center' }}>
                      <div style={{ fontWeight: 700, fontSize: '1.15rem', marginBottom: 18, color: '#1976d2' }}>í’ˆëª© ì¶”ê°€</div>
                      <input type="text" value={newItemName} onChange={e=>setNewItemName(e.target.value)} placeholder="í’ˆëª©ëª…" style={{ width: '100%', borderRadius: 14, border: '2px solid #e0f7fa', padding: 12, fontSize: 16, outline: 'none', marginBottom: 12, background: '#f7faf7', color: '#222', transition: 'border 0.2s', boxSizing: 'border-box', textAlign: 'center', fontWeight: 600 }} />
                      <input type="number" value={newItemPrice} onChange={e=>setNewItemPrice(Number(e.target.value)||0)} placeholder="ê°€ê²©" style={{ width: '100%', borderRadius: 14, border: '2px solid #e0f7fa', padding: 12, fontSize: 16, outline: 'none', marginBottom: 18, background: '#f7faf7', color: '#222', transition: 'border 0.2s', boxSizing: 'border-box', textAlign: 'center', fontWeight: 600 }} />
                      <div style={{ display: 'flex', gap: 10, justifyContent: 'center', marginTop: 8 }}>
                        <button onClick={()=>setShowAddItemModal(false)} style={{ fontWeight: 600, borderRadius: 999, background: '#ffe4ec', color: '#d72660', border: 'none', padding: '8px 32px', fontSize: 15, boxShadow: '0 2px 8px #f8bbd0a0', cursor: 'pointer', transition: 'all 0.2s' }}>ì·¨ì†Œ</button>
                        <button onClick={async()=>{
                          if(!newItemName.trim()) return;
                          await setDoc(doc(db, 'items', newItemName), { name: newItemName.trim(), price: newItemPrice });
                          setShowAddItemModal(false);
                          setNewItemName('');
                          setNewItemPrice(0);
                          setItems(items=>[...items, { id: newItemName, name: newItemName.trim(), price: newItemPrice }]);
                        }} disabled={!newItemName.trim()} style={{ fontWeight: 600, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '8px 32px', fontSize: 15, boxShadow: '0 2px 8px #b2ebf240', opacity: newItemName.trim() ? 1 : 0.5, cursor: newItemName.trim() ? 'pointer' : 'not-allowed', transition: 'all 0.2s' }}>ì¶”ê°€</button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
            {bankTab==='deposit' && (
              <div style={{ minHeight: 220, padding: 10 }}>
                <div style={{ fontWeight: 700, fontSize: 20, color: '#1976d2', marginBottom: 18 }}>ì…ê¸ˆë‚´ì—­</div>
                <div style={{ maxHeight: 420, overflowY: 'auto' }}>
                  <table style={{ width: '100%', borderCollapse: 'collapse', background: '#f7faf7', borderRadius: 16, overflow: 'hidden', fontSize: 16 }}>
                    <thead>
                      <tr style={{ background: '#e0f7fa', color: '#1976d2', fontWeight: 700 }}>
                        <th style={{ padding: 8 }}>í•™ìƒëª…</th>
                        <th style={{ padding: 8 }}>ì‚¬ìœ </th>
                        <th style={{ padding: 8 }}>ê¸ˆì•¡</th>
                        <th style={{ padding: 8 }}>ë‚ ì§œ</th>
                      </tr>
                    </thead>
                    <tbody>
                      {studentsSnapshot && studentsSnapshot.docs.flatMap(doc => {
                        const student = doc.data();
                        return (student.transactions || [])
                          .filter(t => t.type === 'deposit')
                          .sort((a, b) => b.ts - a.ts)
                          .map((t, idx) => (
                            <tr key={doc.id + '-' + t.ts + '-' + idx} style={{ borderBottom: '1px solid #e0f7fa' }}>
                              <td style={{ padding: 8, fontWeight: 600, color: '#1976d2' }}>{student.name}</td>
                              <td style={{ padding: 8 }}>{t.reason}</td>
                              <td style={{ padding: 8, color: '#43a047', fontWeight: 700 }}>{t.amount}ì›</td>
                              <td style={{ padding: 8, color: '#888', fontSize: 14 }}>{new Date(t.ts).toLocaleString('ko-KR')}</td>
                            </tr>
                          ));
                      })}
                    </tbody>
                  </table>
                  {/* ë‚´ì—­ ì—†ì„ ë•Œ ì•ˆë‚´ */}
                  {studentsSnapshot && studentsSnapshot.docs.every(doc => !(doc.data().transactions||[]).some(t => t.type==='deposit')) && (
                    <div style={{ color: '#bbb', fontSize: 18, padding: 40, textAlign: 'center' }}>ì…ê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                  )}
                </div>
              </div>
            )}
            {bankTab==='withdraw' && (
              <div style={{ minHeight: 220, padding: 10 }}>
                <div style={{ fontWeight: 700, fontSize: 20, color: '#d72660', marginBottom: 18 }}>ì§€ì¶œë‚´ì—­</div>
                <div style={{ maxHeight: 420, overflowY: 'auto' }}>
                  <table style={{ width: '100%', borderCollapse: 'collapse', background: '#f7faf7', borderRadius: 16, overflow: 'hidden', fontSize: 16 }}>
                    <thead>
                      <tr style={{ background: '#ffe4ec', color: '#d72660', fontWeight: 700 }}>
                        <th style={{ padding: 8 }}>í•™ìƒëª…</th>
                        <th style={{ padding: 8 }}>êµ¬ì…ë‚´ì—­</th>
                        <th style={{ padding: 8 }}>ê¸ˆì•¡</th>
                        <th style={{ padding: 8 }}>ë‚ ì§œ</th>
                      </tr>
                    </thead>
                    <tbody>
                      {studentsSnapshot && studentsSnapshot.docs.flatMap(doc => {
                        const student = doc.data();
                        return (student.transactions || [])
                          .filter(t => t.type === 'spend')
                          .sort((a, b) => b.ts - a.ts)
                          .map((t, idx) => (
                            <tr key={doc.id + '-' + t.ts + '-' + idx} style={{ borderBottom: '1px solid #ffe4ec' }}>
                              <td style={{ padding: 8, fontWeight: 600, color: '#d72660' }}>{student.name}</td>
                              <td style={{ padding: 8 }}>
                                {t.items && Object.keys(t.items).length > 0 ? (
                                  Object.entries(t.items).map(([item, qty]) => `${item}x${qty}`).join(', ')
                                ) : t.customAmount ? `ì§ì ‘ì…ë ¥: ${t.customAmount}ì›` : '-'}
                              </td>
                              <td style={{ padding: 8, color: '#d72660', fontWeight: 700 }}>{t.amount}ì›</td>
                              <td style={{ padding: 8, color: '#888', fontSize: 14 }}>{new Date(t.ts).toLocaleString('ko-KR')}</td>
                            </tr>
                          ));
                      })}
                    </tbody>
                  </table>
                  {/* ë‚´ì—­ ì—†ì„ ë•Œ ì•ˆë‚´ */}
                  {studentsSnapshot && studentsSnapshot.docs.every(doc => !(doc.data().transactions||[]).some(t => t.type==='spend')) && (
                    <div style={{ color: '#bbb', fontSize: 18, padding: 40, textAlign: 'center' }}>ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      )}
      {showAmountModal && (
        <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.3)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 4000 }}>
          <div style={{ background: '#fff', padding: 32, borderRadius: 24, minWidth: 320, maxWidth: 400, boxShadow: '0 4px 32px #b2ebf240', textAlign: 'center' }}>
            <div style={{ fontWeight: 700, fontSize: '1.15rem', marginBottom: 18, color: '#1976d2' }}>{amountType === 'deposit' ? 'ì…ê¸ˆ' : 'ì¶œê¸ˆ'} ê¸ˆì•¡ ì…ë ¥</div>
            <input type="number" value={amountValue} onChange={e => setAmountValue(Number(e.target.value) || 0)} placeholder="ê¸ˆì•¡" style={{ width: '100%', borderRadius: 14, border: '2px solid #e0f7fa', padding: 12, fontSize: 16, outline: 'none', marginBottom: 18, background: '#f7faf7', color: '#222', transition: 'border 0.2s', boxSizing: 'border-box', textAlign: 'center', fontWeight: 600 }} />
            <div style={{ display: 'flex', gap: 10, justifyContent: 'center', marginTop: 8 }}>
              <button onClick={() => setShowAmountModal(false)} style={{ ...buttonStyle, background: '#ffe4ec', color: '#d72660' }}>ì·¨ì†Œ</button>
              <button onClick={handleAmount} disabled={amountValue <= 0} style={{ ...buttonStyle, background: '#e0f7fa', color: '#1976d2', opacity: amountValue > 0 ? 1 : 0.5 }}>ì™„ë£Œ</button>
            </div>
          </div>
        </div>
      )}
      {/* ê²Œì„ ëª¨ë‹¬ */}
      {showGameModal && (
        <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.3)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 4000 }}>
          <div style={{ 
            background: gameStep === 'reaction' && targetColor ? targetColor.code : '#fff', 
            padding: 36, 
            borderRadius: 32, 
            minWidth: 480, 
            maxWidth: 600, 
            boxShadow: '0 8px 48px #b2ebf240', 
            textAlign: 'center', 
            position: 'relative',
            transition: 'background 0.3s'
          }}>
            <button onClick={() => setShowGameModal(false)} style={{ position: 'absolute', top: 18, right: 18, background: 'none', border: 'none', fontSize: 28, color: gameStep === 'reaction' && targetColor ? '#fff' : '#bbb', cursor: 'pointer', fontWeight: 700 }}>Ã—</button>
            {gameStep === 'select' && (
              <>
                <div style={{ fontWeight: 700, fontSize: 22, color: '#1976d2', marginBottom: 18 }}>ê²Œì„ ì„ íƒ</div>
                <button onClick={() => {
                  setTargetColor(REACTION_COLORS[Math.floor(Math.random()*REACTION_COLORS.length)]);
                  setGameStep('reaction');
                  setReactionTime(null);
                  setGameError('');
                  setStudentName('');
                }} style={{ fontWeight: 700, borderRadius: 999, background: '#e0f7fa', color: '#1976d2', border: 'none', padding: '14px 38px', fontSize: 18, boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', marginBottom: 18 }}>ìˆœë°œë ¥ ê²Œì„</button>
                <div style={{ marginTop: 18 }}>
                  <div style={{ fontWeight: 600, color: '#888', fontSize: 16, marginBottom: 8 }}>TOP 5 ê¸°ë¡</div>
                  <ol style={{ textAlign: 'left', margin: '0 auto', maxWidth: 280 }}>
                    {topRecords.length === 0 && <li style={{ color: '#bbb' }}>ê¸°ë¡ ì—†ìŒ</li>}
                    {topRecords.map((r, i) => <li key={i} style={{ color: '#1976d2', fontWeight: 600 }}>{r.studentName||'ìµëª…'} - {r.ms}ms</li>)}
                  </ol>
                </div>
              </>
            )}
            {gameStep === 'reaction' && (
              <>
                <div style={{ fontWeight: 700, fontSize: 24, color: '#fff', marginBottom: 16, textShadow: '0 2px 4px rgba(0,0,0,0.2)' }}>ì§€ì • ìƒ‰ìƒ: {targetColor?.name}</div>
                <div style={{ marginBottom: 16, color: '#fff', fontSize: 18, textShadow: '0 2px 4px rgba(0,0,0,0.2)' }}>ì•„ë˜ ë°°ê²½ì´ {targetColor?.name}ì´ ë˜ë©´ ìµœëŒ€í•œ ë¹¨ë¦¬ í´ë¦­í•˜ì„¸ìš”!</div>
                {reactionTime === null ? (
                  <div style={{ 
                    width: 320, 
                    height: 240, 
                    margin: '0 auto 24px auto', 
                    borderRadius: 24, 
                    background: currentColor?.code || '#eee', 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'center', 
                    cursor: isClickable ? 'pointer' : 'default', 
                    transition: 'background 0.2s',
                    boxShadow: '0 4px 16px rgba(0,0,0,0.1)'
                  }}
                    onClick={async () => {
                      if (isClickable && currentColor?.code === targetColor?.code) {
                        const ms = Date.now() - startTime;
                        setReactionTime(ms);
                        setIsClickable(false);
                        if (!studentName) {
                          setGameError('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!');
                          return;
                        }
                        await addDoc(collection(db, 'reactionGameRecords'), { studentName, ms, ts: Date.now() });
                        fetchTopRecords();
                      }
                    }}>
                    {isClickable && currentColor?.code === targetColor?.code ? <span style={{ fontWeight: 700, fontSize: 28, color: '#fff', textShadow: '0 2px 8px #0008' }}>ì§€ê¸ˆ í´ë¦­!</span> : ''}
                  </div>
                ) : (
                  <div style={{ fontWeight: 700, fontSize: 28, color: '#fff', margin: '24px 0', textShadow: '0 2px 4px rgba(0,0,0,0.2)' }}>ê¸°ë¡: {reactionTime}ms</div>
                )}
                <div style={{ margin: '16px 0' }}>
                  <input type="text" value={studentName} onChange={e => setStudentName(e.target.value)} placeholder="ì´ë¦„(ë‹‰ë„¤ì„)" style={{ borderRadius: 10, border: '1.5px solid rgba(255,255,255,0.3)', padding: '10px 16px', fontSize: 16, marginBottom: 8, width: 200, background: 'rgba(255,255,255,0.1)', color: '#fff' }} disabled={reactionTime !== null} />
                </div>
                {gameError && <div style={{ color: '#fff', fontWeight: 700, marginBottom: 8, textShadow: '0 2px 4px rgba(0,0,0,0.2)' }}>{gameError}</div>}
                {reactionTime === null ? (
                  <button onClick={() => {
                    setGameError('');
                    setReactionTime(null);
                    setIsClickable(false);
                    let colorInterval = null;
                    let colorChange = () => {
                      const idx = Math.floor(Math.random()*REACTION_COLORS.length);
                      setCurrentColor(REACTION_COLORS[idx]);
                      if (REACTION_COLORS[idx].code === targetColor.code) {
                        setIsClickable(true);
                        setStartTime(Date.now());
                        clearInterval(colorInterval);
                      }
                    };
                    setTimeout(() => {
                      colorInterval = setInterval(colorChange, 1000 + Math.random()*1000);
                    }, 1500 + Math.random()*1500);
                  }} disabled={gameStarted || isClickable} style={{ fontWeight: 700, borderRadius: 999, background: 'rgba(255,255,255,0.2)', color: '#fff', border: 'none', padding: '12px 36px', fontSize: 18, boxShadow: '0 2px 8px rgba(0,0,0,0.1)', cursor: 'pointer', marginTop: 8 }}>ì‹œì‘</button>
                ) : (
                  <button onClick={() => { setGameStep('select'); setReactionTime(null); setCurrentColor(null); setIsClickable(false); fetchTopRecords(); }} style={{ fontWeight: 700, borderRadius: 999, background: 'rgba(255,255,255,0.2)', color: '#fff', border: 'none', padding: '12px 36px', fontSize: 18, boxShadow: '0 2px 8px rgba(0,0,0,0.1)', cursor: 'pointer', marginTop: 8 }}>ë‹¤ì‹œí•˜ê¸°</button>
                )}
              </>
            )}
          </div>
        </div>
      )}
      <div style={{ position: 'fixed', right: 32, bottom: 32, zIndex: 3000 }}>
        <button onClick={() => { setShowGameModal(true); setGameStep('select'); setReactionTime(null); setGameError(''); fetchTopRecords(); }} style={{ background: '#fffde7', border: 'none', borderRadius: 999, padding: '12px 18px', boxShadow: '0 2px 8px #b2ebf240', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 8 }}>
          <SportsEsportsIcon style={{ color: '#1976d2', fontSize: 32 }} />
          <span style={{ fontWeight: 700, color: '#1976d2', fontSize: 17 }}>ê²Œì„ í™œì„±í™”</span>
        </button>
      </div>
    </div>
  );
};

export default TeacherPage; // TEST_DIRECT_EDIT_456
